---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(here)
library(ggplot2)
library(dplyr)

bano.a2a <- function(df, relative = FALSE) {
  if(relative == FALSE){
    df %>% 
      group_by(Activity) %>%
      summarise(across(everything(), ~ sum(!is.na(.x))))
  } else {
    df %>%
      group_by(Activity) %>%
      summarise(across(everything(), ~ sum(!is.na(.x)) / n()))
  }
}

dropSuperfluousAttributes <- function(df, dropCols = NULL) {
  if(is.null(dropCols)) {
    dropCols <- c("Case.ID", "Resource", "Timestamp", "Variant", "Lifecycle")
  }
  df %>% select(-contains(dropCols))
}
```


```{r dataLoading}
OfferApplications <- read.csv(here("data", "bpi17.csv"))
OfferApplications <- dropSuperfluousAttributes(OfferApplications, c("Resource", "Timestamp", "Variant", "Lifecycle", "Event", "Action"))
OfferApplications[OfferApplications == ""] <- NA 
OfferApplications[OfferApplications == 0] <- NA
Offers <- read.csv(here("data", "bpi17_offer_log.csv"))
Offers[Offers == ""] <- NA
Offers[Offers == 0] <- NA

Permits <- read.csv(here("data", "PermitLog.csv"))
Permits[Permits == ""] <- NA
InternationalDeclarations <- read.csv(here("data", "InternationalDeclarations.csv"))
InternationalDeclarations[InternationalDeclarations == ""] <- NA
DomesticDeclarations <- read.csv(here("data", "DomesticDeclarations.csv"))
DomesticDeclarations[DomesticDeclarations == ""] <- NA
RequestForPayment <- read.csv(here("data", "RequestForPayment.csv"))
RequestForPayment[RequestForPayment == ""] <- NA
PrepaidTravelCost <- read.csv(here("data", "PrepaidTravelCost.csv"))
PrepaidTravelCost[PrepaidTravelCost == ""] <- NA

eventlogmockP1 <- read.csv("D:/uni/bpm/eventlogmockP1.csv")
eventlogmockP1[eventlogmockP1 == ""] <- NA
eventlogmockP2 <- read.csv("D:/uni/bpm/eventlogmockP2.csv")
eventlogmockP2[eventlogmockP2 == ""] <- NA

RoadTraffic <- read.csv("D:/uni/bpm/data/Road_Traffic_Fine_Management_Process.csv")
RoadTraffic[RoadTraffic == ""] <- NA
RoadTraffic[RoadTraffic == 0] <- NA
```


```{r Similarity}
positionalSimilarity <- function(){

}

occurenceSimilarity <- function(){
  
}
durationSimilarity <- function(){
  
}
attributeNameSimilarity <- function(){
  
}
attributeValueSimilarity <- function(){
  
}
prerequisiteSimilarity <- function(){
  
}
```


```{r bpi2017}
OfferApplications.a2a <- bano.a2a(OfferApplications)
OfferApplications.a2a.relative <- bano.a2a(OfferApplications, relative = TRUE)
Offers.a2a <- bano.a2a(Offers)
Offers.a2a.relative <- bano.a2a(Offers, relative = TRUE)

Offer.union <- bind_rows(OfferApplications, Offers)
Offer.union.a2a <- bano.a2a(Offer.union)

Offer.union.a2a.relative <- bano.a2a(Offer.union, relative = TRUE)
rownames(OfferApplications.a2a)
  
Offers <- dropSuperfluousAttributes(Offers)
```


```{r bpi2020}
permits.union <- bind_rows(DomesticDeclarations, InternationalDeclarations, Permits, PrepaidTravelCost, RequestForPayment)
permits.union.a2a <- bano.a2a(permits.union)

permits.union.a2a.rel <- bano.a2a(Permits, relative = TRUE)
Permits.a2a <- bano.a2a(Permits, relative = TRUE)
PrepaidTravelCost.a2a <- bano.a2a(PrepaidTravelCost, relative = TRUE)
RequestForPayment.a2a <- bano.a2a(RequestForPayment, relative = TRUE)
DomesticDeclarations.a2a <- bano.a2a(DomesticDeclarations, relative = TRUE)
InternationalDeclarations.a2a <- bano.a2a(InternationalDeclarations, relative = TRUE)


```


```{r mock}


mock1.bano <- bano.a2a(eventlogmockP1)
mock2.bano <- bano.a2a(eventlogmockP2)

```
```{r}

```

```{r }
names.1 <- colnames(EL.1)
names.2 <- colnames(EL.2)


cat("Columns only in log.1:", names.1[!names.1 %in% names.2], "\n",
    "Columns only in log.2:", names.2[!names.2 %in% names.1])
```

```{r Approach 0}
#Rule 1 not applicable

#Rule 3
EL.offerless <- EL.1[!EL.1$Activity == "O_Create Offer", ]
# only "O_Create Offer" has any values in FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount

EL.NAfree <- EL.offerless[!is.na(EL.offerless$CreditScore), ] #empty

# EL COMPLEMENT E_A1 => E_A2 = NA 
# => E_A1 UNION E_A2 = E_A1
# => "O_Create Offer" is an isolated Activity with non-isolated attributes (FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount), with ONE class.


#-------------------------------------------
#Rule 2
EL.OfferID.exists <- EL.1[!is.na(EL.1$OfferID), ]
#head(EL.OfferID.exists)
activities.offerID.access <- unique(EL.OfferID.exists$Activity)
#cat(c("Rule 2 fulfilled by: ", activities.offerID.access, "\n")) #Activities accessing Attr "OfferID"


#Rule 4
EL.Remaining <- EL.offerless[! EL.offerless$Activity %in% activities.offerID.access, ]
#cat(c("OfferID empty?", sum(is.na(EL.Remaining$OfferID)) == nrow(EL.Remaining), "\n"))
#cat(c("OfferedAmount empty?", sum(is.na(EL.Remaining$OfferedAmount)) == nrow(EL.Remaining)))
# => Everything remaining accesses everything



#===>
#3. FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount
#2. OfferID accessed by O_Created, O_Sent, O_Returned O_Accepted O_Refused O_Cancelled O_Sent
#4. Everything else


cat(c("Rule 1: ", "not applicable", "\n"))
cat(c("Rule 2: ", unique(EL.OfferID.exists$Activity), "\n"))
cat(c("Rule 3: ", "FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount", "\n"))
cat(c("Rule 4: ", "Variant, Variant.index, lifecycle.transition, EventOrigin, Action, LoanGoal, ApplicationType, RequestedAmount", "\n"))
```

```{r Graphing}
library(igraph)
library(textshape)
inc <- OfferApplications.a2a
inc <- column_to_rownames(inc, 1)
g <- graph_from_incidence_matrix(inc, multiple = FALSE)

l <- layout.bipartite(g, vgap = 0.1)
plot(g, layout=-l[,2:1],
     vertex.label.cex=0.75, 
     vertex.label.family="Helvetica",
     vertex.label.font=1,
     
     vertex.shape="circle", 
     vertex.size=1, 
     vertex.label.color="black",
     edge.width=1,
     asp = 0.5,
     margin = 0)

plot(g,
     vertex.label.cex=0.75, 
     vertex.label.family="Helvetica",
     vertex.label.font=1,
     
     vertex.shape="circle", 
     vertex.size=1, 
     vertex.label.color="black",
     edge.width=1,
     asp = 0.5,
     margin = 0)

```
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).



```{r}
temp <- Offer.union %>% 
      group_by(Activity) %>%
      summarise(across(everything(), ~ sum(!is.na(.x)) / n()))
temp2 <- bano.a2a(Offer.union, relative = TRUE)
```



```{r}
library(dm)
dm(DomesticDeclarations, InternationalDeclarations, PrepaidTravelCost, RequestForPayment, Permits)
```

```{r RoadTraffic}
RoadTraffic.a2a <- bano.a2a(RoadTraffic)
RoadTraffic.a2a.relative <- bano.a2a(RoadTraffic, relative = TRUE)
summary(RoadTraffic$points)


```



The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
