---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(here)
library(ggplot2)
library(dplyr)
library(tidyverse)

a2a <- function(df, relative = FALSE) {
  if(relative == FALSE){
    df %>% 
      group_by(Activity) %>%
      summarise(across(everything(), ~ sum(!is.na(.x))))
  } else {
    df %>%
      group_by(Activity) %>%
      summarise(across(everything(), ~ sum(!is.na(.x)) / n()))
  }
}

dropSuperfluousAttributes <- function(df, dropCols = NULL) {
  if(is.null(dropCols)) {
    dropCols <- c("Case.ID", "Resource", "Timestamp", "Variant", "Lifecycle")
  }
  df %>% select(-contains(dropCols))
}

replaceEmptyWithNA <- function(df, keepZeroes = FALSE) {
  df[df == ""] <- NA
  if(keepZeroes == FALSE) df[df == "0"] <- NA
  df
}

rule5.setup <- function(a2a) {
  df <- slice(a2a, 0)
  df <- bind_rows(df, a2a %>% select(Activity))
  df[is.na(df)] <- 0
  df
}

rule5.fill <- function(scaffold, a2a) {
  columns <- colnames(a2a)
  rows <- rownames(a2a)
  for(c in columns) {
    for(r in rows) {
      scaffold[r, c] <- a2a[r, c]
    }
  }
  scaffold
}
```

```{r}
t <- rule5.fill(permits.scaffold, RequestForPayment.a2a)
s <- rule5.fill(permits.scaffold, Permits.a2a)
z <- t[,-1] +s[,-1]
#TODO HEEEEEEEEEEERE
```

```{r dataLoading Offers}
# This dataset makes a distinction between NA and 0, so 0 stays.
OfferApplications.orig <- read.csv(here("data", "bpi17.csv"))
OfferApplicatrmions <- dropSuperfluousAttributes(OfferApplications.orig, c("Resource", "Timestamp", "Variant", "Lifecycle", "Event", "Action"))
OfferApplications <- replaceEmptyWithNA(OfferApplications, keepZeroes = TRUE)
Offers.orig <- read.csv(here("data", "bpi17_offer_log.csv"))
Offers <- dropSuperfluousAttributes(Offers.orig, c("Resource", "Timestamp", "Variant", "Lifecycle", "Event", "Action"))
Offers <- replaceEmptyWithNA(Offers, keepZeroes = TRUE)
```


```{r dataLoading Permits}
Permits.orig <- read.csv(here("data", "PermitLog.csv"))
Permits <- replaceEmptyWithNA(Permits.orig)
Permits <- dropSuperfluousAttributes(Permits)

InternationalDeclarations.orig <- read.csv(here("data", "InternationalDeclarations.csv"))
InternationalDeclarations <- replaceEmptyWithNA(InternationalDeclarations.orig)
InternationalDeclarations <- dropSuperfluousAttributes(InternationalDeclarations)

DomesticDeclarations.orig <- read.csv(here("data", "DomesticDeclarations.csv"))
DomesticDeclarations <- replaceEmptyWithNA(DomesticDeclarations.orig)
DomesticDeclarations <- dropSuperfluousAttributes(DomesticDeclarations)

RequestForPayment.orig <- read.csv(here("data", "RequestForPayment.csv"))
RequestForPayment <- replaceEmptyWithNA(RequestForPayment.orig)
RequestForPayment <- dropSuperfluousAttributes(RequestForPayment)

PrepaidTravelCost.orig <- read.csv(here("data", "PrepaidTravelCost.csv"))
PrepaidTravelCost <- replaceEmptyWithNA(PrepaidTravelCost.orig)
PrepaidTravelCost <- dropSuperfluousAttributes(PrepaidTravelCost)

```


```{r dataLoading Mock}
eventlogmockP1 <- read.csv("D:/uni/bpm/eventlogmockP1.csv")
eventlogmockP1[eventlogmockP1 == ""] <- NA
eventlogmockP2 <- read.csv("D:/uni/bpm/eventlogmockP2.csv")
eventlogmockP2[eventlogmockP2 == ""] <- NA
```


```{r dataLoading Traffic}
RoadTraffic <- read.csv("D:/uni/bpm/data/Road_Traffic_Fine_Management_Process.csv")
RoadTraffic <- replaceEmptyWithNA(RoadTraffic)
RoadTraffic <- dropSuperfluousAttributes(RoadTraffic)
```


```{r bpi2017}
OfferApplications.a2a <- a2a(OfferApplications)
OfferApplications.a2a.relative <- a2a(OfferApplications, relative = TRUE)
Offers.a2a <- a2a(Offers)
Offers.a2a.relative <- a2a(Offers, relative = TRUE)

Offer.union <- bind_rows(OfferApplications, Offers)
Offer.union.a2a <- a2a(Offer.union)

Offer.union.a2a.relative <- a2a(Offer.union, relative = TRUE)
rownames(OfferApplications.a2a)
  
Offers <- dropSuperfluousAttributes(Offers)
```


```{r bpi2020}

Permits.a2a <- a2a(Permits, relative = TRUE)
DomesticDeclarations.a2a <- a2a(DomesticDeclarations, relative = TRUE)
InternationalDeclarations.a2a <- a2a(InternationalDeclarations, relative = TRUE)
PrepaidTravelCost.a2a <- a2a(PrepaidTravelCost, relative = TRUE)
RequestForPayment.a2a <- a2a(RequestForPayment, relative = TRUE)

permits.union <- bind_rows(DomesticDeclarations, InternationalDeclarations, Permits, PrepaidTravelCost, RequestForPayment)
permits.union.a2a <- a2a(permits.union)

permits.scaffold <- rule5.setup(permits.union.a2a)

permits.union.a2a.rel <- a2a(Permits, relative = TRUE)
Permits.a2a <- a2a(Permits)
PrepaidTravelCost.a2a <- a2a(PrepaidTravelCost)
RequestForPayment.a2a <- a2a(RequestForPayment)
DomesticDeclarations.a2a <- a2a(DomesticDeclarations)
InternationalDeclarations.a2a <- a2a(InternationalDeclarations)


smolPermits <- Permits %>% select(Activity, BudgetNumber, Overspent, OverspentAmount, ProjectNumber, RequestedBudget, TotalDeclared, id)
smolDomesticDeclarations <- DomesticDeclarations %>% select(Activity, Amount, BudgetNumber, id)
smolInternationalDeclarations <- InternationalDeclarations %>% select(Activity, Amount, BudgetNumber, id, Permit)
smolRequestForPayment <- RequestForPayment %>% select(Activity, Project, RequestedAmount, Rfp_id)
smolPrepaidTravelCost <- PrepaidTravelCost %>% select(Activity, Project, RequestedAmount, Rfp_id, Permit.id)

smolUnion <- bind_rows(smolPermits, smolDomesticDeclarations, smolInternationalDeclarations, smolRequestForPayment, smolPrepaidTravelCosts)
smolUnion.a2a <- a2a(smolUnion)
smolPermits.a2a <- a2a(smolPermits)
smolPermits.a2a.rel <- a2a(smolPermits, relative = TRUE)
smolDomesticDeclarations.a2a <- a2a(smolDomesticDeclarations)
smolInternationalDeclarations.a2a <- a2a(smolInternationalDeclarations)
smolRequestForPayment.a2a <- a2a(smolRequestForPayment)
smolPrepaidTravelCost.a2a <- a2a(smolPrepaidTravelCost)

sort(intersect(colnames(smolPermits), colnames(smolInternationalDeclarations)))
sort(intersect(colnames(smolPermits), colnames(smolDomesticDeclarations)))
sort(intersect(colnames(smolPermits), colnames(smolRequestForPayment)))
sort(intersect(colnames(smolPermits), colnames(smolPrepaidTravelCost)))

sort(intersect(colnames(smolInternationalDeclarations), colnames(smolDomesticDeclarations)))
sort(intersect(colnames(smolInternationalDeclarations), colnames(smolRequestForPayment)))
sort(intersect(colnames(smolInternationalDeclarations), colnames(smolPrepaidTravelCost)))

sort(intersect(colnames(smolDomesticDeclarations), colnames(smolRequestForPayment)))
sort(intersect(colnames(smolDomesticDeclarations), colnames(smolPrepaidTravelCost)))

sort(intersect(colnames(smolRequestForPayment), colnames(smolPrepaidTravelCost)))
smolRfpPre.union <- bind_rows(smolRequestForPayment, smolPrepaidTravelCost)
smolRfpPre.union.a2a <- a2a(smolRfpPre.union)

smolIntDom.union <- bind_rows(smolInternationalDeclarations, smolDomesticDeclarations)
smolIntDom.union.a2a <- a2a(smolIntDom.union)
```

```{r bpi2020 multilogAccess}

sort(intersect(colnames(Permits), colnames(InternationalDeclarations)))
sort(intersect(colnames(Permits), colnames(DomesticDeclarations)))
sort(intersect(colnames(Permits), colnames(RequestForPayment)))
sort(intersect(colnames(Permits), colnames(PrepaidTravelCost)))

sort(intersect(colnames(InternationalDeclarations), colnames(DomesticDeclarations)))
sort(intersect(colnames(InternationalDeclarations), colnames(RequestForPayment)))
sort(intersect(colnames(InternationalDeclarations), colnames(PrepaidTravelCost)))

sort(intersect(colnames(DomesticDeclarations), colnames(RequestForPayment)))
sort(intersect(colnames(DomesticDeclarations), colnames(PrepaidTravelCost)))

sort(intersect(colnames(RequestForPayment), colnames(PrepaidTravelCost)))

intersect(intersect(colnames(RequestForPayment), colnames(PrepaidTravelCost)), colnames(DomesticDeclarations))


DomInt.union <- bind_rows(DomesticDeclarations, InternationalDeclarations)
DomInt.union.a2a <- a2a(DomInt.union)

PrepaidRfp.union <- bind_rows(PrepaidTravelCost, RequestForPayment)
PrepaidRfp.union.a2a <- a2a(PrepaidRfp.union)


```


```{r }
names.1 <- colnames(EL.1)
names.2 <- colnames(EL.2)


cat("Columns only in log.1:", names.1[!names.1 %in% names.2], "\n",
    "Columns only in log.2:", names.2[!names.2 %in% names.1])
```

```{r Approach 0}
#Rule 1 not applicable

#Rule 3
EL.offerless <- EL.1[!EL.1$Activity == "O_Create Offer", ]
# only "O_Create Offer" has any values in FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount

EL.NAfree <- EL.offerless[!is.na(EL.offerless$CreditScore), ] #empty

# EL COMPLEMENT E_A1 => E_A2 = NA 
# => E_A1 UNION E_A2 = E_A1
# => "O_Create Offer" is an isolated Activity with non-isolated attributes (FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount), with ONE class.


#-------------------------------------------
#Rule 2
EL.OfferID.exists <- EL.1[!is.na(EL.1$OfferID), ]
#head(EL.OfferID.exists)
activities.offerID.access <- unique(EL.OfferID.exists$Activity)
#cat(c("Rule 2 fulfilled by: ", activities.offerID.access, "\n")) #Activities accessing Attr "OfferID"


#Rule 4
EL.Remaining <- EL.offerless[! EL.offerless$Activity %in% activities.offerID.access, ]
#cat(c("OfferID empty?", sum(is.na(EL.Remaining$OfferID)) == nrow(EL.Remaining), "\n"))
#cat(c("OfferedAmount empty?", sum(is.na(EL.Remaining$OfferedAmount)) == nrow(EL.Remaining)))
# => Everything remaining accesses everything



#===>
#3. FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount
#2. OfferID accessed by O_Created, O_Sent, O_Returned O_Accepted O_Refused O_Cancelled O_Sent
#4. Everything else


cat(c("Rule 1: ", "not applicable", "\n"))
cat(c("Rule 2: ", unique(EL.OfferID.exists$Activity), "\n"))
cat(c("Rule 3: ", "FirstWithdrawalAmount, NumberOfTerms, Accepted, MonthlyCost, Selected, CreditScore, OfferedAmount", "\n"))
cat(c("Rule 4: ", "Variant, Variant.index, lifecycle.transition, EventOrigin, Action, LoanGoal, ApplicationType, RequestedAmount", "\n"))
```

```{r Graphing}
library(igraph)
library(textshape)
inc <- OfferApplications.a2a
inc <- column_to_rownames(inc, 1)
g <- graph_from_incidence_matrix(inc, multiple = FALSE)

l <- layout.bipartite(g, vgap = 0.1)
plot(g, layout=-l[,2:1],
     vertex.label.cex=0.75, 
     vertex.label.family="Helvetica",
     vertex.label.font=1,
     
     vertex.shape="circle", 
     vertex.size=1, 
     vertex.label.color="black",
     edge.width=1,
     asp = 0.5,
     margin = 0)

plot(g,
     vertex.label.cex=0.75, 
     vertex.label.family="Helvetica",
     vertex.label.font=1,
     
     vertex.shape="circle", 
     vertex.size=1, 
     vertex.label.color="black",
     edge.width=1,
     asp = 0.5,
     margin = 0)

```
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).



```{r}
temp <- Offer.union %>% 
      group_by(Activity) %>%
      summarise(across(everything(), ~ sum(!is.na(.x)) / n()))
temp2 <- a2a(Offer.union, relative = TRUE)
```

```{r RoadTraffic}
RoadTraffic.a2a <- a2a(RoadTraffic)
RoadTraffic.a2a.relative <- a2a(RoadTraffic, relative = TRUE)
write.csv(RoadTraffic.a2a, "roadTrafficA2A.csv")
```

```{r Similarity}
positionalSimilarity <- function(){

}

occurenceSimilarity <- function(){
  
}
durationSimilarity <- function(){
  
}
attributeNameSimilarity <- function(){
  
}
attributeValueSimilarity <- function(){
  
}
prerequisiteSimilarity <- function(){
  
}
```

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
